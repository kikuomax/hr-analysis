<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <title>Personal HR Analysis: HR</title>
  <link rel='stylesheet' href='/lib/bootstrap-3.3.7/css/bootstrap.min.css'>
  <script src='/lib/jquery-3.2.1.min.js'></script>
  <script src='/lib/bootstrap-3.3.7/js/bootstrap.min.js'></script>
  <script src='/lib/vue.min.js'></script>
  <script src='/lib/URI-1.18.10.js'></script>
  <script src='/lib/d3.min.js'></script>
  <script>
    $(() => {
        // processes user input
        const model = new Vue({
            el: '#request-form',
            data: {
                year: '',
                month: '',
                day: '',
                startHour: '',
                startMinute: '',
                stopHour: '',
                stopMinute: ''
            },
            methods: {
                requestHeartRate: function () {
                    // you cannot use the arrow notation
                    requestHeartRate(
                        this.year,
                        this.month,
                        this.day,
                        this.startHour,
                        this.startMinute,
                        this.stopHour,
                        this.stopMinute);
                    // closes the dialog
                    $('#request-form').modal('hide');
                }
            }
        });

        // prepares the plot area
        const margin = {
            top: 20,
            right: 20,
            bottom: 30,
            left: 50
        };
        const container = document.querySelector('#plot-container');
        const svg = d3.select('#plot-area');
        svg.attr('width', container.clientWidth);
        svg.attr('height', container.clientHeight);
        const width = container.clientWidth - (margin.left + margin.right);
        const height = container.clientHeight - (margin.top + margin.bottom);
        const g = svg.append('g')
            .attr('transform', `translate(${margin.left}, ${margin.top})`);
        const parseDateTime = d3.timeParse('%Y-%m-%dT%H:%M:%S');
        const x = d3.scaleTime().rangeRound([0, width]);
        const y = d3.scaleLinear().rangeRound([height, 0]);
        y.domain([30, 200]);
        const line = d3.line()
            .defined((d) => d)
            .x((d) => x(d.time))
            .y((d) => y(d.value));
        const path = g.append('path')
            .attr('fill', 'none')
            .attr('stroke', 'steelblue')
            .attr('stroke-linejoin', 'round')
            .attr('stroke-linecap', 'round')
            .attr('stroke-width', 1.0)
            .attr('marker-start', 'url(#circle-marker)')
            .attr('marker-mid', 'url(#circle-marker)')
            .attr('marker-end', 'url(#circle-marker)');
        const xAxis = g.append('g')
            .attr('class', 'axis axis-x')
            .attr('transform', `translate(0, ${height})`)
            .call(d3.axisBottom(x));
        g.append('g')
            .attr('class', 'axis axis-y')
            .call(d3.axisLeft(y));

        // requests the heart rate and renders it
        function requestHeartRate(
            year, month, day, startHour, startMinute, stopHour, stopMinute)
        {
            const uri = new URI('/data/heart-rate.json').query({
                date: `${year}-${month}-${day}`,
                startTime: `${startHour}:${startMinute}`,
                stopTime: `${stopHour}:${stopMinute}`
            });
            $.ajax(uri.toString())
                .done((contents) => {
                    const date = contents['activities-heart'][0].dateTime;
                    let data = contents['activities-heart-intraday'].dataset
                        .map((d) => {
                            d.time = parseDateTime(`${date}T${d.time}`);
                            return d;
                        });
                    x.domain([
                        new Date(year, month - 1, day, startHour, startMinute),
                        new Date(year, month - 1, day, stopHour, stopMinute)]);
                    data = chunkData(data);
                    data = data.map((d) => d.concat([null]));
                    data = Array.prototype.concat.apply([], data);
                    xAxis.call(d3.axisBottom(x));
                    path.datum(data)
                        .attr('d', line);
                });
        }

        function chunkData(data) {
            const MAX_GAP = 15 * 1000;  // in milliseconds
            const chunks = [];
            let chunkStart = 0;
            for (let i = 0; (i + 1) < data.length; ++i) {
                const gap =
                    data[i + 1].time.getTime() - data[i].time.getTime();
                if (gap > MAX_GAP) {
                    chunks.push(data.slice(chunkStart, i + 1));
                    chunkStart = i + 1;
                }
            }
            if (chunkStart < data.length) {
                chunks.push(data.slice(chunkStart, data.length));
            }
            return chunks;
        }

        // shows the request form
        $('#request-form').modal('show');
    });
  </script>
  <style type='text/css'>
    #plot-container {
      width: 100%;
      height: 300px;
    }
  </style>
</head>
<body>
  <div class='container'>
     <div>
      <button type='button' class='btn btn-primary' data-toggle='modal' data-target='#request-form'>Request HR</button>
    </div>
    <div id='plot-container'>
      <svg id='plot-area'>
        <defs>
          <marker id='circle-marker'
              markerWidth='3' markerHeight='3' refX='1' refY='1'>
            <circle cx='1' cy='1' r='1' style='stroke: none; fill: #000000' />
          </marker>
        </defs>
      </svg>
    </div>
  </div>
  <!-- request form -->
  <div id='request-form' class='modal fade' tabindex='-1' role='dialog' aria-labelledby='request-form-label'>
    <div class='modal-dialog' role='document'>
      <div class='modal-content'>
        <div class='modal-header'>
          <button type='button' class='close' data-dismiss='modal' aria-label='Close'><span aria-hidden='true'>&times;</span></button>
          <h4 id='request-form-label' class='modal-title'>Request HR</h4>
        </div>
        <div class='modal-body'>
          <form v-on:submit.prevent='requestHeartRate'>
            <label for='year'>Year</label>
            <input id='year' class='form-control'
                v-model='year' placeholder='yyyy' size='4'>
            <label for='month'>Month</label>
            <input id='month' class='form-control'
                v-model='month' placeholder='mm' size='2'>
            <label for='day'>Day</label>
            <input id='day' class='form-control'
                v-model='day' placeholder='dd' size='2'>
            <label for='start-hour'>Start hour</label>
            <input id='start-hour' class='form-control'
                v-model='startHour' placeholder='HH' size='2'>
            <label for='start-minute'>Start minute</label>
            <input id='start-minute' class='form-control'
                v-model='startMinute' placeholder='MM' size='2'>
            <label for='stop-hour'>Stop hour</label>
            <input id='stop-hour' class='form-control'
                v-model='stopHour' placeholder='HH' size='2'>
            <label for='stop-minute'>Stop minute</label>
            <input id='stop-minute' class='form-control'
                v-model='stopMinute' placeholder='MM' size='2'>
            <label for='submit-request' class='sr-only'>Submit</label>
          </form>
        </div>
        <div class='modal-footer'>
          <button type='button' class='btn btn-default' data-dismiss='modal'>Cancel</button>
          <button type='button' class='btn btn-primary' v-on:click='requestHeartRate'>Request</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>

